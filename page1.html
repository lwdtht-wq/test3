<script>
/* ==========================================================
   DATASET
========================================================== */

const data = [
  { year: 2010, traditional: 83, tech: 0, none: 17 },
  { year: 2020, traditional: 78, tech: 0, none: 22 },
  { year: 2030, traditional: 60, tech: 5, none: 35 },
  { year: 2040, traditional: 48, tech: 18, none: 34 },
  { year: 2050, traditional: 35, tech: 32, none: 33 },
  { year: 2075, traditional: 20, tech: 55, none: 25 },
  { year: 2100, traditional: 12, tech: 68, none: 20 },
  { year: 2150, traditional: 5,  tech: 82, none: 13 }
];

const width = 900;
const height = 420;
const margin = { top: 40, right: 80, bottom: 40, left: 70 };

const svg = d3.select("#chart")
  .append("svg")
  .attr("width", width)
  .attr("height", height)
  .style("cursor", "crosshair");

/* ==========================================================
   SCALES
========================================================== */

const x = d3.scaleLinear()
  .domain(d3.extent(data, d => d.year))
  .range([margin.left, width - margin.right]);

const y = d3.scaleLinear()
  .domain([0, 100])
  .range([height - margin.bottom, margin.top]);

/* ==========================================================
   AXES
========================================================== */

svg.append("g")
  .attr("transform", `translate(0, ${height - margin.bottom})`)
  .call(d3.axisBottom(x).ticks(7).tickFormat(d3.format("d")))
  .attr("color", "#7bc4ff");

svg.append("g")
  .attr("transform", `translate(${margin.left}, 0)`)
  .call(d3.axisLeft(y))
  .attr("color", "#7bc4ff");

/* ==========================================================
   NICE COLORS
========================================================== */
const colors = {
  traditional: "#ff3df2",
  tech: "#4af1ff",
  none: "#8cc7ff"
};

/* ==========================================================
   DRAW LINES WITH ANIMATION
========================================================== */

function drawAnimatedLine(key, color) {
  const lineGen = d3.line()
    .x(d => x(d.year))
    .y(d => y(d[key]))
    .curve(d3.curveCatmullRom.alpha(0.5));

  const path = svg.append("path")
    .datum(data)
    .attr("fill", "none")
    .attr("stroke", color)
    .attr("stroke-width", 2.6)
    .attr("d", lineGen)
    .style("filter", "drop-shadow(0 0 6px " + color + ")");

  // -> Animation: draw from left to right
  const totalLength = path.node().getTotalLength();
  path
    .attr("stroke-dasharray", totalLength + " " + totalLength)
    .attr("stroke-dashoffset", totalLength)
    .transition()
    .duration(1600)
    .ease(d3.easeCubicOut)
    .attr("stroke-dashoffset", 0);

  // -> Add label
  svg.append("text")
    .attr("x", x(data[data.length - 1].year) + 10)
    .attr("y", y(data[data.length - 1][key]))
    .attr("fill", color)
    .attr("font-size", "14px")
    .text(key === "traditional" ? "Traditional" :
          key === "tech" ? "Techno-Faith" : "None");

  return path;
}

const paths = {
  traditional: drawAnimatedLine("traditional", colors.traditional),
  tech:         drawAnimatedLine("tech", colors.tech),
  none:         drawAnimatedLine("none", colors.none)
};

/* ==========================================================
   GLOW PARTICLES ON LINES
========================================================== */
function createMovingDot(path, color) {
  const length = path.node().getTotalLength();
  const dot = svg.append("circle")
    .attr("r", 5)
    .attr("fill", color)
    .style("filter", "drop-shadow(0 0 8px " + color + ")");

  function animateDot() {
    dot.transition()
      .duration(3500)
      .ease(d3.easeLinear)
      .attrTween("transform", function () {
        return function (t) {
          const p = path.node().getPointAtLength(t * length);
          return `translate(${p.x},${p.y})`;
        };
      })
      .on("end", animateDot);
  }

  animateDot();
}

createMovingDot(paths.traditional, colors.traditional);
createMovingDot(paths.tech, colors.tech);
createMovingDot(paths.none, colors.none);

/* ==========================================================
   HIGHLIGHT LINE WHEN MOUSE NEAR
========================================================== */
svg.on("mousemove", function (event) {
  const [mx, my] = d3.pointer(event);

  Object.keys(paths).forEach(key => {
    const path = paths[key];
    const dist = Math.abs(my - path.node().getPointAtLength(path.node().getTotalLength() / 2).y);

    // If Y distance is close â†’ highlight
    if (dist < 80) {
      path.attr("stroke-width", 4).style("filter", "drop-shadow(0 0 10px " + colors[key] + ")");
    } else {
      path.attr("stroke-width", 2.6).style("filter", "drop-shadow(0 0 5px " + colors[key] + ")");
    }
  });
});

/* ==========================================================
   VERTICAL YEAR FOLLOWER LINE
========================================================== */
const vLine = svg.append("line")
  .attr("stroke", "#4af1ff55")
  .attr("stroke-width", 2)
  .style("pointer-events", "none")
  .style("display", "none");

svg.on("mousemove", function (event) {
  const [mx] = d3.pointer(event);

  vLine
    .style("display", "block")
    .attr("x1", mx)
    .attr("x2", mx)
    .attr("y1", margin.top)
    .attr("y2", height - margin.bottom);
});

svg.on("mouseleave", function () {
  vLine.style("display", "none");
});

</script>
